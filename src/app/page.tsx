'use client'

import { useState, useEffect } from 'react'
import { Search, Plus, Hash, Cloud } from 'lucide-react'
import TreeNavigation from '../components/TreeNavigation'
import NoteDetailView from '../components/NoteDetailView'
import RecentNotes from '../components/RecentNotes'
import GlobalSearch from '../components/GlobalSearch'
import BackupManager from '../components/BackupManager'
import ColorPicker from '../components/ColorPicker'
import TagManager from '../components/TagManager'
import CloudStorage from '../components/CloudStorage'
import ResizableLayout from '../components/ResizableLayout'
import { Note, Category } from '../types'
import { NotesStorage, CategoriesStorage, TagsStorage } from '../lib/storage'
import ArticleView from '../components/ArticleView'
import NoteEditor from '../components/NoteEditor'
import TableOfContents from '../components/TableOfContents'

export default function Home() {
  const [notes, setNotes] = useState<Note[]>([])
  const [categories, setCategories] = useState<Category[]>([])
  const [selectedCategory, setSelectedCategory] = useState<string>('ÂÖ®ÈÉ®')
  const [searchQuery, setSearchQuery] = useState('')
  const [isEditorOpen, setIsEditorOpen] = useState(false)
  const [editingNote, setEditingNote] = useState<Note | undefined>()
  const [selectedNote, setSelectedNote] = useState<Note | undefined>()
  const [isSearchOpen, setIsSearchOpen] = useState(false)
  const [isTagManagerOpen, setIsTagManagerOpen] = useState(false)
  const [isCloudStorageOpen, setIsCloudStorageOpen] = useState(false)
  const [backgroundColor, setBackgroundColor] = useState('#f8f9fa')

  // ÂàùÂßãÂåñÊï∞ÊçÆ
  useEffect(() => {
    const loadedNotes = NotesStorage.getNotes()
    const loadedCategories = CategoriesStorage.getCategories()
    
    setNotes(loadedNotes)
    setCategories(loadedCategories)
    
    // Êõ¥Êñ∞Ê†áÁ≠æËÆ°Êï∞
    TagsStorage.updateTagCounts(loadedNotes)
    
    // Â¶ÇÊûúÊ≤°ÊúâÁ¨îËÆ∞ÔºåÊ∑ªÂä†‰∏Ä‰∫õÁ§∫‰æãÊï∞ÊçÆ
    if (loadedNotes.length === 0) {
      const sampleNotes = [
        {
          title: 'React 18 Êñ∞ÁâπÊÄßÂ≠¶‰π†Á¨îËÆ∞',
          content: 'Ê∑±ÂÖ•‰∫ÜËß£ React 18 ÁöÑÂπ∂ÂèëÁâπÊÄßÂíå Suspense ÊîπËøõ„ÄÇConcurrent Features ËÆ© React ËÉΩÂ§ü‰∏≠Êñ≠Ê∏≤ÊüìÂ∑•‰ΩúÔºå‰ºòÂÖàÂ§ÑÁêÜÊõ¥ÈáçË¶ÅÁöÑÊõ¥Êñ∞„ÄÇAutomatic Batching Ëá™Âä®ÊâπÂ§ÑÁêÜÂ§ö‰∏™Áä∂ÊÄÅÊõ¥Êñ∞ÔºåÊèêÂçáÊÄßËÉΩ„ÄÇ',
          category: 'Â≠¶‰π†Á¨îËÆ∞',
          tags: ['React', 'ÂâçÁ´Ø', 'JavaScript'],
          isPublished: true
        },
        {
          title: 'AI ËæÖÂä©ÁºñÁ®ãÂ∑•ÂÖ∑ÂØπÊØî',
          content: 'ÂØπÊØî‰∫Ü GitHub Copilot„ÄÅCursor Á≠â AI ÁºñÁ®ãÂä©ÊâãÁöÑÁâπÁÇπ„ÄÇGitHub Copilot Âú®‰ª£Á†ÅË°•ÂÖ®ÊñπÈù¢Ë°®Áé∞‰ºòÁßÄÔºåCursor Âú®Êï¥‰ΩìÂºÄÂèë‰ΩìÈ™å‰∏äÊõ¥Âä†Êô∫ËÉΩ„ÄÇ',
          category: 'ÊäÄÊúØÂàÜ‰∫´',
          tags: ['AI', 'ÁºñÁ®ãÂ∑•ÂÖ∑', 'ÊïàÁéá'],
          isPublished: true
        },
        {
          title: 'Êï∞Â≠óËä±Âõ≠ËÆæËÆ°ÊÄùË∑Ø',
          content: 'ÊûÑÂª∫‰∏™‰∫∫Áü•ËØÜÁÆ°ÁêÜÁ≥ªÁªüÁöÑ‰∏Ä‰∫õÊÉ≥Ê≥ï„ÄÇÈááÁî®Âç°ÁâáÂºèÁ¨îËÆ∞ÔºåÊîØÊåÅÊ†áÁ≠æÂàÜÁ±ªÔºåÂÆûÁé∞Áü•ËØÜÁöÑÁΩëÁä∂ËøûÊé•„ÄÇÈáçÁÇπÊòØË¶ÅËÆ©Áü•ËØÜËÉΩÂ§üËá™ÁÑ∂ÁîüÈïøÔºåÂΩ¢ÊàêÊúâÊú∫ÁöÑÁü•ËØÜÁΩëÁªú„ÄÇ',
          category: 'ÈöèÁ¨î',
          tags: ['Áü•ËØÜÁÆ°ÁêÜ', 'ËÆæËÆ°ÊÄùË∑Ø', '‰∏™‰∫∫ÊàêÈïø'],
          isPublished: false
        }
      ]
      
      sampleNotes.forEach(noteData => {
        NotesStorage.addNote(noteData)
      })
      
      setNotes(NotesStorage.getNotes())
      TagsStorage.updateTagCounts(NotesStorage.getNotes())
    }
  }, [])

  // ÂÖ®Â±ÄÂø´Êç∑ÈîÆ
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // Ctrl/Cmd + K ÊâìÂºÄÊêúÁ¥¢
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault()
        setIsSearchOpen(true)
      }
    }

    document.addEventListener('keydown', handleKeyDown)
    return () => document.removeEventListener('keydown', handleKeyDown)
  }, [])


  // Â§ÑÁêÜËÉåÊôØÈ¢úËâ≤ÂèòÂåñ
  const handleBackgroundColorChange = (color: string) => {
    setBackgroundColor(color)
    localStorage.setItem('digital-garden-background-color', color)
  }

  // ‰øùÂ≠òÁ¨îËÆ∞
  const handleSaveNote = (noteData: Omit<Note, 'id' | 'createdAt' | 'updatedAt'>) => {
    if (editingNote) {
      // Êõ¥Êñ∞Áé∞ÊúâÁ¨îËÆ∞
      const updatedNote = NotesStorage.updateNote(editingNote.id, noteData)
      if (updatedNote) {
        setNotes(NotesStorage.getNotes())
        TagsStorage.updateTagCounts(NotesStorage.getNotes())
      }
    } else {
      // ÂàõÂª∫Êñ∞Á¨îËÆ∞
      NotesStorage.addNote(noteData)
      setNotes(NotesStorage.getNotes())
      TagsStorage.updateTagCounts(NotesStorage.getNotes())
    }
    
    setIsEditorOpen(false)
    setEditingNote(undefined)
  }

  // Âà†Èô§Á¨îËÆ∞
  const handleDeleteNote = (id: string) => {
    const deleted = NotesStorage.deleteNote(id)
    if (deleted) {
      setNotes(NotesStorage.getNotes())
      TagsStorage.updateTagCounts(NotesStorage.getNotes())
      // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÁ¨îËÆ∞ÔºåÊ∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
      if (selectedNote?.id === id) {
        setSelectedNote(undefined)
      }
    }
  }

  // ÈáçÂëΩÂêçÁ¨îËÆ∞
  const handleRenameNote = (noteId: string, newTitle: string) => {
    const updatedNote = NotesStorage.updateNote(noteId, { title: newTitle })
    if (updatedNote) {
      setNotes(NotesStorage.getNotes())
      // Â¶ÇÊûúÈáçÂëΩÂêçÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÁ¨îËÆ∞ÔºåÊõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
      if (selectedNote?.id === noteId) {
        setSelectedNote(updatedNote)
      }
    }
  }

  // ÁßªÂä®Á¨îËÆ∞
  const handleMoveNote = (noteId: string, targetCategory: string) => {
    const updatedNote = NotesStorage.moveNote(noteId, targetCategory)
    if (updatedNote) {
      setNotes(NotesStorage.getNotes())
      // Â¶ÇÊûúÁßªÂä®ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÁ¨îËÆ∞ÔºåÊõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
      if (selectedNote?.id === noteId) {
        setSelectedNote(updatedNote)
      }
    }
  }

  // ÈÄâÊã©Á¨îËÆ∞
  const handleNoteSelect = (note: Note) => {
    setSelectedNote(note)
  }

  // Êï∞ÊçÆÊÅ¢Â§çÂêéÂà∑Êñ∞
  const handleDataRestore = () => {
    setNotes(NotesStorage.getNotes())
    setCategories(CategoriesStorage.getCategories())
    TagsStorage.updateTagCounts(NotesStorage.getNotes())
    setSelectedNote(undefined)
    setSelectedCategory('ÂÖ®ÈÉ®')
  }

  // Ê∑ªÂä†ÂàÜÁ±ª
  const handleAddCategory = (categoryName: string, parentId?: string) => {
    const newCategory = CategoriesStorage.addCategory(categoryName, parentId)
    if (newCategory) {
      setCategories(CategoriesStorage.getCategories())
    }
  }

  // ÁºñËæëÂàÜÁ±ª
  const handleEditCategory = (oldName: string, newName: string) => {
    const updated = CategoriesStorage.updateCategory(oldName, newName)
    if (updated) {
      setCategories(CategoriesStorage.getCategories())
      // Êõ¥Êñ∞ÊâÄÊúâ‰ΩøÁî®ËØ•ÂàÜÁ±ªÁöÑÁ¨îËÆ∞
      const updatedNotes = notes.map(note => 
        note.category === oldName ? { ...note, category: newName } : note
      )
      updatedNotes.forEach(note => {
        if (note.category === newName) {
          NotesStorage.updateNote(note.id, note)
        }
      })
      setNotes(NotesStorage.getNotes())
      
      // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÂàÜÁ±ªË¢´ÈáçÂëΩÂêçÔºåÊõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
      if (selectedCategory === oldName) {
        setSelectedCategory(newName)
      }
    }
  }

  // Âà†Èô§ÂàÜÁ±ª
  const handleDeleteCategory = (categoryName: string) => {
    // Â∞ÜËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâÁ¨îËÆ∞ÁßªÂä®Âà∞"Êú™ÂàÜÁ±ª"
    const categoryNotes = notes.filter(note => note.category === categoryName)
    categoryNotes.forEach(note => {
      NotesStorage.updateNote(note.id, { ...note, category: 'Êú™ÂàÜÁ±ª' })
    })
    
    // Âà†Èô§ÂàÜÁ±ª
    CategoriesStorage.deleteCategory(categoryName)
    setCategories(CategoriesStorage.getCategories())
    setNotes(NotesStorage.getNotes())
    
    // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÂàÜÁ±ªË¢´Âà†Èô§ÔºåÂàáÊç¢Âà∞"ÂÖ®ÈÉ®"
    if (selectedCategory === categoryName) {
      setSelectedCategory('ÂÖ®ÈÉ®')
    }
  }

  // ÂàÜÁ±ªÈÄâÊã©
  const handleCategorySelect = (categoryName: string) => {
    setSelectedCategory(categoryName)
    setSelectedNote(undefined)
  }

  // Âú®ÊåáÂÆöÂàÜÁ±ª‰∏ãÊ∑ªÂä†Á¨îËÆ∞
  const handleAddNoteToCategory = (categoryName: string) => {
    setSelectedCategory(categoryName)
    setEditingNote(undefined)
    setIsEditorOpen(true)
  }


  // ‰ΩøÁî®ÊåáÂÆöÊ†áÈ¢òÂàõÂª∫Á¨îËÆ∞
  const handleCreateNoteWithTitle = (categoryName: string, title: string) => {
    const noteData = {
      title,
      content: '',
      category: categoryName,
      tags: [],
      isPublished: true
    }
    
    NotesStorage.addNote(noteData)
    setNotes(NotesStorage.getNotes())
    TagsStorage.updateTagCounts(NotesStorage.getNotes())
    
    // ÈÄâÊã©Êñ∞ÂàõÂª∫ÁöÑÁ¨îËÆ∞
    const newNotes = NotesStorage.getNotes()
    const newNote = newNotes.find(note => note.title === title && note.category === categoryName)
    if (newNote) {
      setSelectedNote(newNote)
      setSelectedCategory(categoryName)
    }
  }

  return (
    <div 
      className="min-h-screen transition-colors duration-300 text-[#52575b]"
      style={{ backgroundColor: backgroundColor }}
    >
      <header className="">
        <div className="max-w-7xl ml-4 mr-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <h1 className="text-xl font-normal text-[#52575b]">
              üå±Â∞èÂÆáÁöÑÊï∞Â≠óËä±Âõ≠
            </h1>
            
            <div className="flex items-center gap-4">
              <button
                onClick={() => setIsSearchOpen(true)}
                className="p-2 rounded-lg transition-colors bg-white text-[#52575b] hover:bg-gray-50"
                title="ÊêúÁ¥¢ (Ctrl+K)"
              >
                <Search className="w-5 h-5" />
              </button>
              <button
                onClick={() => setIsTagManagerOpen(true)}
                className="p-2 rounded-lg transition-colors bg-white text-[#52575b] hover:bg-gray-50"
                title="Ê†áÁ≠æÁÆ°ÁêÜ"
              >
                <Hash className="w-5 h-5" />
              </button>
              <button
                onClick={() => setIsCloudStorageOpen(true)}
                className="p-2 rounded-lg transition-colors bg-white text-[#52575b] hover:bg-gray-50"
                title="‰∫ëÂ≠òÂÇ®"
              >
                <Cloud className="w-5 h-5" />
              </button>
              <BackupManager 
                isDark={false} 
                onDataRestore={handleDataRestore}
              />
              <ColorPicker
                isDark={false}
                onColorChange={handleBackgroundColorChange}
                currentColor={backgroundColor}
              />
            </div>
          </div>
        </div>
      </header>

      <div className="h-[calc(100vh-120px)]">
        <ResizableLayout
          isDark={false}
          leftPanel={
            <div className="p-4">
              <h2 className="text-sm font-semibold mb-3 text-[#2d3748]">
                ÂØºËà™
              </h2>
              <TreeNavigation
                categories={categories}
                notes={notes}
                selectedNote={selectedNote}
                isDark={false}
                onNoteSelect={handleNoteSelect}
                onCategorySelect={handleCategorySelect}
                onAddNoteToCategory={handleAddNoteToCategory}
                onCreateNoteWithTitle={handleCreateNoteWithTitle}
                onAddCategory={handleAddCategory}
                onEditCategory={handleEditCategory}
                onDeleteCategory={handleDeleteCategory}
                onRenameNote={handleRenameNote}
                onMoveNote={handleMoveNote}
                onDeleteNote={handleDeleteNote}
              />
            </div>
          }
          centerPanel={
            selectedNote ? (
              <NoteDetailView
                note={selectedNote}
                isDark={false}
                notes={notes}
                onSave={(noteData) => {
                  const updatedNote = NotesStorage.updateNote(selectedNote.id, noteData)
                  if (updatedNote) {
                    setNotes(NotesStorage.getNotes())
                    TagsStorage.updateTagCounts(NotesStorage.getNotes())
                    setSelectedNote(updatedNote)
                  }
                }}
                onNoteSelect={setSelectedNote}
              />
            ) : (
              <div className="p-8 h-full flex items-center justify-center">
                <div className="text-center">
                  <div className="text-6xl mb-4">üå±</div>
                  <h2 className="text-2xl font-bold mb-4 text-[#2d3748]">
                    Ê¨¢ËøéÊù•Âà∞Â∞èÂÆáÁöÑÊï∞Â≠óËä±Âõ≠
                  </h2>
                  <p className="text-lg text-[#666]">
                    Âú®ËøôÈáåËÆ∞ÂΩï‰Ω†ÁöÑÊÉ≥Ê≥ïÔºåËÆ©Áü•ËØÜÁîüÊ†πÂèëËäΩ
                  </p>
                </div>
              </div>
            )
          }
          rightPanel={
            <div className="p-4 space-y-6">
              <RecentNotes 
                notes={notes} 
                isDark={false}
                onNoteSelect={handleNoteSelect}
              />
              
              {/* ÁõÆÂΩïÂØºËà™ - ‰ªÖÂú®ÈÄâ‰∏≠Á¨îËÆ∞‰∏îÊúâÊ†áÈ¢òÊó∂ÊòæÁ§∫ */}
              {selectedNote && selectedNote.content && (() => {
                const tempDiv = document.createElement('div')
                tempDiv.innerHTML = selectedNote.content
                const allHeadings = tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6, .custom-heading-1, .custom-heading-2, .custom-heading-3')
                return allHeadings.length > 0
              })() && (
                <TableOfContents 
                  content={selectedNote.content} 
                  isDark={false}
                />
              )}
            </div>
          }
        />
      </div>

      {/* Á¨îËÆ∞ÁºñËæëÂô® */}
      {isEditorOpen && (
        <NoteEditor
          note={editingNote}
          categories={categories}
          isDark={false}
          onSave={handleSaveNote}
          onCancel={() => {
            setIsEditorOpen(false)
            setEditingNote(undefined)
          }}
        />
      )}

      {/* ÂÖ®Â±ÄÊêúÁ¥¢ */}
      <GlobalSearch
        notes={notes}
        isDark={false}
        onNoteSelect={handleNoteSelect}
        isOpen={isSearchOpen}
        onClose={() => setIsSearchOpen(false)}
      />

      {/* Ê†áÁ≠æÁÆ°ÁêÜÂô® */}
      {isTagManagerOpen && (
        <TagManager
          onClose={() => setIsTagManagerOpen(false)}
          isDark={false}
        />
      )}

      {/* ‰∫ëÂ≠òÂÇ®ÁÆ°ÁêÜÂô® */}
      {isCloudStorageOpen && (
        <CloudStorage
          onClose={() => setIsCloudStorageOpen(false)}
          isDark={false}
        />
      )}
    </div>
  )
}
